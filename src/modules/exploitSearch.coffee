###

Copyright (C) 2013, Jesus Perez <jesusprubio gmail com>

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.

###


# ---------------------- Requires --------------------------------

request = require "request"
xml2js = require "xml2js"
{Printer} = require "../tools/printer"


# ----------------------- Class ----------------------------------

# This class includes some functions related with exploitsearch.net API. 
exports.ExploitSearch =
class ExploitSearch
		
	connected = false
	# Time to wait for an API response.
	timeOut = 20000

	printVulnsInfo = (info) ->
		Printer.info "\n\nName: "
		Printer.normal info.name
		Printer.info "\nSource: "
		Printer.normal info.src
		Printer.info "\nID: "
		Printer.result info.id
		Printer.info "\nInfo:"
		if info.info.src
			Printer.info "\n\tSrc: "
			Printer.normal "#{info.info.src}"
		if info.info.title
			Printer.info "\n\tTitle: "
			Printer.normal "#{info.info.title}"
		if info.info.desc
			Printer.info "\n\tDesc: "
			Printer.normal "#{info.info.desc}"
		if info.info.cvss
			Printer.info "\n\tCVSS: "
			Printer.normal "#{info.info.cvss}"
		if info.info.copyright_title
			Printer.info "\n\tCopyright title: "
			Printer.normal "#{info.info.copyright_title}"
		if info.info.copyright_link
			Printer.info "\n\tCopyright link: "
			Printer.normal "#{info.info.copyright_link}"
		# if (info.exploits.length is 0)
		Printer.info "\nExploits: "
		Printer.normal "#{info.exploits}"
		Printer.info "\nDates:"
		if info.dates.initial
			Printer.info "\n\tInitial: "
			Printer.normal "#{info.dates.initial}"
		if info.dates.updated
			Printer.info "\n\tUpdated: "
			Printer.normal "#{info.dates.updated}"

	callback = () ->
		if not connected
			Printer.error "Connection problem: Can't reach the target or no response"


	# It looks for known vulnerabilities for an specific service version
	@search = (service, version, onlyExploits) ->
		baseUrl = 'http://www.exploitsearch.net/json.php?q='
		setTimeout callback, timeOut
		# We use request library to get a JSON file and parse it
		if onlyExploits is "no"
			only = "0"
		else
			only = "1"
		query = "#{service}"
		query += "%20#{version}" if version
		customUri = "#{baseUrl}#{query}&e=#{only}"
		# We need to include an user-agent to avoid blocks.
		customHeaders = {"User-Agent": "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Ubuntu Chromium/28.0.1500.71 Chrome/28.0.1500.71 Safari/537.36"}
		request.get { uri: customUri, headers: customHeaders, json: true }, (err, r, body) ->
			connected = true
			if err
				Printer.error "ExploitSearch: connection problem: #{err}"
			else
				if body.error
					Printer.error "ExploitSearch: #{body.error}"
				else
					if (body.length is 0)
						Printer.highlight "\nNo vulns found.\n"
					else
						printVulnsInfo info for info in body